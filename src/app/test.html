<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Microsoft OAuth Login Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 500px;
        width: 100%;
      }

      h1 {
        color: #334155;
        margin-bottom: 10px;
        font-size: 24px;
      }

      p {
        color: #64748b;
        margin-bottom: 30px;
      }

      .button-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      button {
        padding: 15px 24px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .admin-btn {
        background: #dc2626;
        color: white;
      }

      .admin-btn:hover {
        background: #b91c1c;
      }

      .staff-btn {
        background: #2563eb;
        color: white;
      }

      .staff-btn:hover {
        background: #1d4ed8;
      }

      .response {
        margin-top: 30px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: none;
      }

      .response.show {
        display: block;
      }

      .response h2 {
        color: #334155;
        font-size: 18px;
        margin-bottom: 15px;
      }

      .response pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.6;
      }

      .info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .info strong {
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Microsoft OAuth Login Test</h1>
      <p>Test Microsoft authentication for different roles</p>

      <div class="info">
        <strong>üìã Test Requirements:</strong>
        ‚Ä¢ You must be a member of the respective Azure AD security group<br />
        ‚Ä¢ Admin: Churchill Portal Admins<br />
        ‚Ä¢ Staff: Churchill Portal Staff
      </div>

      <div class="button-group">
        <button class="admin-btn" onclick="loginAs('admin')">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
              clip-rule="evenodd"
            />
          </svg>
          Login as Admin
        </button>

        <button class="staff-btn" onclick="loginAs('staff')">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"
            />
          </svg>
          Login as Staff
        </button>
      </div>

      <div class="response" id="response">
        <h2>üì¶ Response:</h2>
        <pre id="responseContent"></pre>
      </div>
    </div>

    <script>
      const API_BASE = "https://apply.churchill.edu.au/api/v1";

      async function loginAs(role) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "Getting auth URL...";

        try {
          // Get auth URL from backend API
          const response = await fetch(
            `${API_BASE}/auth/microsoft/login?role=${role}`
          );

          if (!response.ok) {
            throw new Error("Failed to get auth URL");
          }

          const data = await response.json();

          // Redirect to Microsoft login
          window.location.href = data.auth_url;
        } catch (error) {
          alert("Error: " + error.message);
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // Check if we're being redirected back with data in URL
      window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");

        console.log(
          "Page loaded. Code:",
          code,
          "State:",
          state,
          "Error:",
          error
        );

        if (error) {
          console.error("OAuth error:", error);
          showResponse({
            error: error,
            error_description: urlParams.get("error_description"),
          });
        } else if (code) {
          console.log("Found code, exchanging for tokens...");
          // Exchange code for tokens by calling the callback endpoint
          exchangeCodeForTokens(code, state);
        } else {
          console.log("No code or error - normal page load");
        }
      });

      async function exchangeCodeForTokens(code, state) {
        console.log(
          "Calling callback API with code:",
          code.substring(0, 20) + "..."
        );
        try {
          const response = await fetch(
            `${API_BASE}/auth/microsoft/callback?code=${code}&state=${
              state || ""
            }`
          );
          console.log("Response status:", response.status);

          const data = await response.json();
          console.log("Response data:", data);

          if (response.ok) {
            showResponse(data);

            // Store tokens for testing
            if (data.access_token) {
              console.log("Storing tokens in localStorage");
              localStorage.setItem("access_token", data.access_token);
              localStorage.setItem("user_info", JSON.stringify(data.user));
            }
          } else {
            console.error("Authentication failed:", data);
            showResponse({
              error: "Authentication failed",
              details: data,
            });
          }
        } catch (error) {
          console.error("Network error:", error);
          showResponse({
            error: "Network error",
            message: error.message,
          });
        }
      }

      function showResponse(data) {
        const responseDiv = document.getElementById("response");
        const responseContent = document.getElementById("responseContent");

        responseContent.textContent = JSON.stringify(data, null, 2);
        responseDiv.classList.add("show");
      }
    </script>
    <script
      defer
      src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
      integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
      data-cf-beacon='{"version":"2024.11.0","token":"527a31ede0f145b1837311fb1bf07f7d","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}'
      crossorigin="anonymous"
    ></script>
  </body>
</html>
